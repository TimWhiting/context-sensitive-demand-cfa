#lang racket/base
(require "demand.rkt" "all-examples.rkt" "static-contexts.rkt" "config.rkt" "debug.rkt" racket/match)

(define (hash-num-keys h) (foldl (lambda (_ acc) (add1 acc)) 0 (hash-keys h)))
(define (zip l1 l2) (map list l1 l2))

(module+ main
  (require racket/pretty)
  (for ([m (in-range 3)])
    (show-envs-simple #t)
    (current-m m)
    (let ([basic-cost 0]
          [hybrid-cost 0])
      (for ([example successful-examples])
        (match-let ([`(example ,name ,exp) example])
          (define out-basic (open-output-file (string-append "tests/m" (number->string (current-m)) "/" (symbol->string name) "-basic-results.txt") #:exists 'replace))
          (define out-hybrid (open-output-file (string-append "tests/m" (number->string (current-m)) "/" (symbol->string name) "-hybrid-results.txt") #:exists 'replace))
          (pretty-displayn 0 "")
          (pretty-displayn 0 "")
          (pretty-display "Analyzing expression: ")
          (pretty-print exp)
          (pretty-print `(expression: ,exp) out-basic)
          (pretty-print `(expression: ,exp) out-hybrid)
          (pretty-displayn 0 "")
          ; (show-envs #t)
          ; (trace 1)
          (demand-kind 'basic)
          (let ([qbs (gen-queries (cons `(top) exp) (list))])
            (demand-kind 'hybrid)
            (let ([qhs (gen-queries (cons `(top) exp) (list))])
              (for ([qs (zip qbs qhs)])
                (match-let ([h1 (hash)]
                            [h2 (hash)]
                            ; TODO: Is it okay for the continuations to escape and be reused later?
                            [(list (list cb pb) (list ch ph)) qs])
                  (define evalqb (eval cb pb))
                  (define evalqh (eval ch ph))
                  (pretty-tracen 0 "Running query ")
                  (pretty-print `(query: ,(show-simple-ctx cb) ,pb) out-basic)
                  (pretty-print `(query: ,(show-simple-ctx ch) ,ph) out-hybrid)
                  ; (pretty-print `(query: ,(show-simple-ctx cb) ,pb))
                  ; (pretty-print `(query: ,(show-simple-ctx ch) ,ph))

                  (demand-kind 'basic)
                  (set! h1 (run-get-hash evalqb h1))
                  (set! basic-cost (+ basic-cost (hash-num-keys h1)))
                  (pretty-result-out out-basic (from-hash evalqb h1))

                  (demand-kind 'hybrid)
                  (set! h2 (run-get-hash evalqh h2))
                  (set! hybrid-cost (+ hybrid-cost (hash-num-keys h2)))
                  (pretty-tracen 0 (from-hash evalqh h2))
                  (pretty-result-out out-hybrid (from-hash evalqh h2))
                  ; (pretty-print h2)
                  (if (equal-simplify-envs? (from-hash evalqb h1) (from-hash evalqh h2))
                      '() ; (pretty-print "Results match")
                      (begin
                        (pretty-print "ERROR: Hybrid and Basic results differ" (current-error-port))
                        (displayln "" (current-error-port))
                        (pretty-print `(query: ,(show-simple-ctx cb) ,pb) (current-error-port))
                        (pretty-display "Basic result: " (current-error-port))
                        (pretty-result-out (current-error-port) (simplify-envs (from-hash evalqb h1)))
                        (displayln "" (current-error-port))
                        (pretty-print `(query: ,(show-simple-ctx ch) ,ph) (current-error-port))
                        (pretty-display "Hybrid result: " (current-error-port))
                        (pretty-result-out (current-error-port) (simplify-envs (from-hash evalqh h2)))
                        (displayln "" (current-error-port))
                        )
                      )
                  )
                )

              )
            )
          (close-output-port out-basic)
          (close-output-port out-hybrid)
          )
        )
      (pretty-print `(current-m: ,(current-m)))
      (pretty-print `(basic-cost ,basic-cost))
      (pretty-print `(hybrid-cost ,hybrid-cost))
      )
    )
  )
